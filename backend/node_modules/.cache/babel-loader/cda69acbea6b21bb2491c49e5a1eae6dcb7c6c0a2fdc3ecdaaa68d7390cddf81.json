{"ast":null,"code":"var _s = $RefreshSig$();\n// src/controllers/DietaBalanceadaController.js\nimport { useEffect, useMemo, useState } from \"react\";\nimport { buildInfoGeneral, buildMateriasSeleccionadas, buildDetallesBromatologicos, DETALLE_KEYS } from \"../models/dietaBalanceada.model\";\n\n// Importa solo lo que existe en tu MateriasController\nimport { cargarDetalleMateria } from \"./MateriasController\";\n\n/**\r\n * Resuelve la fuente de datos del Paso 1 (Datos del animal):\r\n * 1) Prop recibida,\r\n * 2) DietasController.getDatosAnimal(),\r\n * 3) localStorage(\"np_datosAnimal\")\r\n */\nexport function resolveDatosAnimal(DietasController, datosAnimalProp) {\n  if (datosAnimalProp) return datosAnimalProp;\n  if (typeof (DietasController === null || DietasController === void 0 ? void 0 : DietasController.getDatosAnimal) === \"function\") {\n    const fromCtl = DietasController.getDatosAnimal();\n    if (fromCtl) return fromCtl;\n  }\n  try {\n    const ls = localStorage.getItem(\"np_datosAnimal\");\n    if (ls) return JSON.parse(ls);\n  } catch (_) {}\n  return {};\n}\n\n/**\r\n * Hook controlador para DietaBalanceada:\r\n * - Sesión 1: Información general\r\n * - Sesión 2: Listado con detalles bromatológicos por materia (Banco y Temporales)\r\n */\nexport function useDietaBalanceadaController(DietasController, datosAnimalProp) {\n  _s();\n  const [raw, setRaw] = useState(null);\n\n  // Paso 3: selección + restricciones\n  const [seleccionadas, setSeleccionadas] = useState([]);\n  const [restricciones, setRestricciones] = useState({});\n\n  // Detalles bromatológicos por id de materia\n  const [detallesById, setDetallesById] = useState({});\n\n  // Carga inicial de datos generales + selección y restricciones\n  useEffect(() => {\n    // Sesión 1\n    const data = resolveDatosAnimal(DietasController, datosAnimalProp);\n    setRaw(data || {});\n\n    // Sesión 2: materias seleccionadas\n    const sel = typeof (DietasController === null || DietasController === void 0 ? void 0 : DietasController.getSeleccionadas) === \"function\" ? DietasController.getSeleccionadas() : JSON.parse(localStorage.getItem(\"np_sel\") || \"[]\");\n\n    // Restricciones (costo/min/max)\n    const restr = typeof (DietasController === null || DietasController === void 0 ? void 0 : DietasController.getRestricciones) === \"function\" ? DietasController.getRestricciones() : JSON.parse(localStorage.getItem(\"np_restr\") || \"{}\");\n    setSeleccionadas(Array.isArray(sel) ? sel : []);\n    setRestricciones(restr && typeof restr === \"object\" ? restr : {});\n  }, [DietasController, datosAnimalProp]);\n\n  // Cargar detalles bromatológicos (Banco y Temporales)\n  useEffect(() => {\n    let cancel = false;\n\n    // Opcional: detalles de materias temporales guardados por el formulario de Materia Temporal\n    // Estructura sugerida: { [idTemporal]: { MS: 88, EM: 1.5, ... } }\n    let tempDetallesLS = {};\n    try {\n      tempDetallesLS = JSON.parse(localStorage.getItem(\"np_temp_detalles\") || \"{}\");\n    } catch (_) {}\n    async function fetchDetalles() {\n      const acc = {};\n      for (const m of seleccionadas || []) {\n        try {\n          // Si es temporal, prioriza detalle inline o en LS\n          if (m.temporal || m.isTemporal || m.esTemporal) {\n            var _tempDetallesLS;\n            const inline = m.detalle || m.bromatologia || m.detalles || m.composicion || null;\n            const fromLS = ((_tempDetallesLS = tempDetallesLS) === null || _tempDetallesLS === void 0 ? void 0 : _tempDetallesLS[m.id]) || null;\n            acc[m.id] = inline || fromLS || {};\n            continue;\n          }\n\n          // Banco: cargar desde API/controlador\n          let det = await cargarDetalleMateria(m.id);\n          if (Array.isArray(det)) det = det[0]; // si tu API devuelve array\n          acc[m.id] = det || {};\n        } catch (e) {\n          acc[m.id] = {};\n        }\n      }\n      if (!cancel) setDetallesById(acc);\n    }\n    if (seleccionadas && seleccionadas.length) fetchDetalles();else setDetallesById({});\n    return () => {\n      cancel = true;\n    };\n  }, [seleccionadas]);\n\n  // Sesión 1: Información general (Paso 1)\n  const infoGeneral = useMemo(() => buildInfoGeneral(raw), [raw]);\n\n  // Sesión 2A: Listado simple (nombre/tipo/costo/min/max) si lo necesitas\n  const materias = useMemo(() => buildMateriasSeleccionadas(seleccionadas, restricciones), [seleccionadas, restricciones]);\n\n  // Sesión 2B: Detalles bromatológicos por materia (para la tabla)\n  const detalleKeys = DETALLE_KEYS; // [\"MS\",\"EM\",\"NDT\",\"PB\",\"Ca\",\"P\",\"Mg\",\"Na\",\"K\",\"S\",\"FDN\",\"EE\",\"CNF\"]\n  const materiasConDetalles = useMemo(() => buildDetallesBromatologicos(seleccionadas, detallesById, detalleKeys), [seleccionadas, detallesById, detalleKeys]);\n  return {\n    infoGeneral,\n    materias,\n    materiasConDetalles,\n    detalleKeys\n  };\n}\n_s(useDietaBalanceadaController, \"JS+7ByH1/d1tHeuiJ1/Dx7X/jJE=\");","map":{"version":3,"names":["useEffect","useMemo","useState","buildInfoGeneral","buildMateriasSeleccionadas","buildDetallesBromatologicos","DETALLE_KEYS","cargarDetalleMateria","resolveDatosAnimal","DietasController","datosAnimalProp","getDatosAnimal","fromCtl","ls","localStorage","getItem","JSON","parse","_","useDietaBalanceadaController","_s","raw","setRaw","seleccionadas","setSeleccionadas","restricciones","setRestricciones","detallesById","setDetallesById","data","sel","getSeleccionadas","restr","getRestricciones","Array","isArray","cancel","tempDetallesLS","fetchDetalles","acc","m","temporal","isTemporal","esTemporal","_tempDetallesLS","inline","detalle","bromatologia","detalles","composicion","fromLS","id","det","e","length","infoGeneral","materias","detalleKeys","materiasConDetalles"],"sources":["C:/Users/maico/OneDrive/Documentos/a/backend/src/controllers/DietaBalanceadaController.js"],"sourcesContent":["// src/controllers/DietaBalanceadaController.js\r\nimport { useEffect, useMemo, useState } from \"react\";\r\nimport {\r\n    buildInfoGeneral,\r\n    buildMateriasSeleccionadas,\r\n    buildDetallesBromatologicos,\r\n    DETALLE_KEYS,\r\n} from \"../models/dietaBalanceada.model\";\r\n\r\n// Importa solo lo que existe en tu MateriasController\r\nimport { cargarDetalleMateria } from \"./MateriasController\";\r\n\r\n/**\r\n * Resuelve la fuente de datos del Paso 1 (Datos del animal):\r\n * 1) Prop recibida,\r\n * 2) DietasController.getDatosAnimal(),\r\n * 3) localStorage(\"np_datosAnimal\")\r\n */\r\nexport function resolveDatosAnimal(DietasController, datosAnimalProp) {\r\n    if (datosAnimalProp) return datosAnimalProp;\r\n\r\n    if (typeof DietasController?.getDatosAnimal === \"function\") {\r\n        const fromCtl = DietasController.getDatosAnimal();\r\n        if (fromCtl) return fromCtl;\r\n    }\r\n\r\n    try {\r\n        const ls = localStorage.getItem(\"np_datosAnimal\");\r\n        if (ls) return JSON.parse(ls);\r\n    } catch (_) { }\r\n\r\n    return {};\r\n}\r\n\r\n/**\r\n * Hook controlador para DietaBalanceada:\r\n * - Sesión 1: Información general\r\n * - Sesión 2: Listado con detalles bromatológicos por materia (Banco y Temporales)\r\n */\r\nexport function useDietaBalanceadaController(DietasController, datosAnimalProp) {\r\n    const [raw, setRaw] = useState(null);\r\n\r\n    // Paso 3: selección + restricciones\r\n    const [seleccionadas, setSeleccionadas] = useState([]);\r\n    const [restricciones, setRestricciones] = useState({});\r\n\r\n    // Detalles bromatológicos por id de materia\r\n    const [detallesById, setDetallesById] = useState({});\r\n\r\n    // Carga inicial de datos generales + selección y restricciones\r\n    useEffect(() => {\r\n        // Sesión 1\r\n        const data = resolveDatosAnimal(DietasController, datosAnimalProp);\r\n        setRaw(data || {});\r\n\r\n        // Sesión 2: materias seleccionadas\r\n        const sel =\r\n            typeof DietasController?.getSeleccionadas === \"function\"\r\n                ? DietasController.getSeleccionadas()\r\n                : JSON.parse(localStorage.getItem(\"np_sel\") || \"[]\");\r\n\r\n        // Restricciones (costo/min/max)\r\n        const restr =\r\n            typeof DietasController?.getRestricciones === \"function\"\r\n                ? DietasController.getRestricciones()\r\n                : JSON.parse(localStorage.getItem(\"np_restr\") || \"{}\");\r\n\r\n        setSeleccionadas(Array.isArray(sel) ? sel : []);\r\n        setRestricciones(restr && typeof restr === \"object\" ? restr : {});\r\n    }, [DietasController, datosAnimalProp]);\r\n\r\n    // Cargar detalles bromatológicos (Banco y Temporales)\r\n    useEffect(() => {\r\n        let cancel = false;\r\n\r\n        // Opcional: detalles de materias temporales guardados por el formulario de Materia Temporal\r\n        // Estructura sugerida: { [idTemporal]: { MS: 88, EM: 1.5, ... } }\r\n        let tempDetallesLS = {};\r\n        try {\r\n            tempDetallesLS = JSON.parse(localStorage.getItem(\"np_temp_detalles\") || \"{}\");\r\n        } catch (_) { }\r\n\r\n        async function fetchDetalles() {\r\n            const acc = {};\r\n\r\n            for (const m of seleccionadas || []) {\r\n                try {\r\n                    // Si es temporal, prioriza detalle inline o en LS\r\n                    if (m.temporal || m.isTemporal || m.esTemporal) {\r\n                        const inline =\r\n                            m.detalle || m.bromatologia || m.detalles || m.composicion || null;\r\n                        const fromLS = tempDetallesLS?.[m.id] || null;\r\n\r\n                        acc[m.id] = inline || fromLS || {};\r\n                        continue;\r\n                    }\r\n\r\n                    // Banco: cargar desde API/controlador\r\n                    let det = await cargarDetalleMateria(m.id);\r\n                    if (Array.isArray(det)) det = det[0]; // si tu API devuelve array\r\n                    acc[m.id] = det || {};\r\n                } catch (e) {\r\n                    acc[m.id] = {};\r\n                }\r\n            }\r\n\r\n            if (!cancel) setDetallesById(acc);\r\n        }\r\n\r\n        if (seleccionadas && seleccionadas.length) fetchDetalles();\r\n        else setDetallesById({});\r\n\r\n        return () => {\r\n            cancel = true;\r\n        };\r\n    }, [seleccionadas]);\r\n\r\n    // Sesión 1: Información general (Paso 1)\r\n    const infoGeneral = useMemo(() => buildInfoGeneral(raw), [raw]);\r\n\r\n    // Sesión 2A: Listado simple (nombre/tipo/costo/min/max) si lo necesitas\r\n    const materias = useMemo(\r\n        () => buildMateriasSeleccionadas(seleccionadas, restricciones),\r\n        [seleccionadas, restricciones]\r\n    );\r\n\r\n    // Sesión 2B: Detalles bromatológicos por materia (para la tabla)\r\n    const detalleKeys = DETALLE_KEYS; // [\"MS\",\"EM\",\"NDT\",\"PB\",\"Ca\",\"P\",\"Mg\",\"Na\",\"K\",\"S\",\"FDN\",\"EE\",\"CNF\"]\r\n    const materiasConDetalles = useMemo(\r\n        () => buildDetallesBromatologicos(seleccionadas, detallesById, detalleKeys),\r\n        [seleccionadas, detallesById, detalleKeys]\r\n    );\r\n\r\n    return { infoGeneral, materias, materiasConDetalles, detalleKeys };\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}